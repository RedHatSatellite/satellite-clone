- name: Stop katello services
  command: katello-service stop

# Satellite 6.1 doesn't stop postgresql with katello-service stop
- name: Stop postgresql
  service: name=postgresql state=stopped

- name: Restore postgresql data
  command: tar --selinux --overwrite -xvf {{ backup_dir }}/pgsql_data.tar.gz -C /
  when: not rhel_migration and pgsql_data.stat.exists

- include: restore_postgresql_migration.yml
  when: rhel_migration

- name: Restore pulp data
  command: "tar --selinux --overwrite -xvf {{ backup_dir }}/pulp_data.tar --exclude=var/lib/pulp/katello-export -C /"
  when: pulp_data.stat.exists

- name: Start postgresql
  service: name=postgresql state=started

- include: standard_backup_restore.yml
  when: standard_backup

- name: Start mongod
  service: name=mongod state=started

- include: online_backup_restore.yml
  when: online_backup

- name: migrate pulp db
  command: sudo -u apache pulp-manage-db
